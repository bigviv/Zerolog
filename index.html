 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZeroLog</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo512.png">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_ID" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-dim: #8e8e93;
            --accent: #2563eb;
            --accent-dim: #1d4ed8;
            --success: #32d74b;
            --danger: #ff453a;
            --warning: #ff9f0a;
            --border: #2c2c2e;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* Space for nav */
            overflow-x: hidden;
        }

        /* Typography & Layout */
        h1, h2, h3 { margin: 0; font-weight: 600; }
        .container { padding: 20px; flex: 1; overflow-y: auto; }
        .hidden { display: none !important; }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .nav-item {
            color: var(--text-dim);
            text-align: center;
            font-size: 10px;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* Cards & Inputs */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 8px 12px; font-size: 14px; width: auto; }

        input, select {
            background: #2c2c2e;
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        input:focus { outline: 2px solid var(--accent); }

        /* Workout View */
        .set-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .set-history { font-size: 12px; color: var(--text-dim); margin-bottom: 4px; }
        .exercise-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 8px;
        }
        .badge-pr { background: linear-gradient(45deg, #ff9f0a, #ff453a); color: white; box-shadow: 0 2px 8px rgba(255, 69, 58, 0.4); }

        /* Rest Timer Banner & Ads */
        #timer-banner {
            position: fixed;
            bottom: 70px; /* Above nav */
            left: 10px;
            right: 10px;
            background: #111;
            border: 1px solid var(--accent);
            border-radius: 12px;
            z-index: 90;
            display: none; /* Flex when active */
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .timer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }
        .timer-digits { font-size: 24px; font-weight: bold; font-variant-numeric: tabular-nums; color: var(--accent); }
        .ad-container {
            width: 100%;
            min-height: 50px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #333;
        }
        
        /* AI Insights Section */
        .ai-insight {
            background: linear-gradient(145deg, #1c1c1e 0%, #161618 100%);
            border-left: 3px solid var(--accent);
            margin-bottom: 20px;
            animation: fadeIn 0.5s;
        }
        .insight-header { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .insight-text { font-size: 14px; line-height: 1.4; color: var(--text-dim); }
        .insight-highlight { color: var(--accent); font-weight: 600; }

        /* Toast Notification (Undo) */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #toast.visible { opacity: 1; pointer-events: all; }
        
        /* Utility */
        .text-center { text-align: center; }
        .text-sm { font-size: 13px; }
        .mt-4 { margin-top: 16px; }
        .flex-between { display: flex; justify-content: space-between; }
        
        /* Calculator Plate Visuals */
        .plate-stack { display: flex; align-items: center; justify-content: center; gap: 2px; margin: 20px 0; height: 100px; }
        .bar { width: 10px; height: 100%; background: #555; border-radius: 2px; }
        .plate { height: 80%; width: 15px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 8px; color: #000; font-weight: bold; }
        .p-20 { background: #2563eb; height: 90%; width: 20px; }
        .p-10 { background: #32d74b; height: 70%; }
        .p-5 { background: #ff453a; height: 50%; }
        .p-2-5 { background: #8e8e93; height: 40%; }
    </style>
</head>
<body>

    <div id="toast">
        <span id="toast-msg">Item deleted</span>
        <button class="btn-sm btn-outline" onclick="undoAction()" style="border-color: #555;">UNDO</button>
    </div>

    <div id="view-workout" class="container">
        <div class="flex-between" style="align-items: flex-end; margin-bottom: 20px;">
            <h1>Workout</h1>
            <span class="text-sm" style="color:var(--text-dim)" id="current-date"></span>
        </div>

        <div id="ai-insights-area"></div>

        <div id="workout-list"></div>
        
        <button class="btn btn-outline" onclick="showExerciseSelector()">+ Add Exercise</button>

        <div id="exercise-selector" class="card hidden" style="margin-top: 20px;">
            <h3>Add Exercise</h3>
            <input type="text" id="new-exercise-name" placeholder="Search or Type new..." list="exercise-suggestions">
            <datalist id="exercise-suggestions">
                </datalist>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="addNewExercise()">Add</button>
                <button class="btn btn-danger" onclick="hideExerciseSelector()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="view-history" class="container hidden">
        <h1>History</h1>
        <div id="history-list" class="mt-4"></div>
        <button class="btn btn-outline mt-4" onclick="exportData()">Export Data (JSON)</button>
        <div style="margin-top:10px;">
            <label class="btn btn-outline" style="display:block; text-align:center;">
                Import Data (JSON)
                <input type="file" onchange="importData(this)" style="display:none" accept=".json">
            </label>
        </div>
    </div>

    <div id="view-calc" class="container hidden">
        <h1>Plate Calc</h1>
        <div class="card mt-4">
            <label class="text-sm">Target Weight (kg)</label>
            <input type="number" id="calc-weight" value="100" oninput="calculatePlates()" inputmode="decimal">
            <div class="plate-stack" id="plate-visuals">
                </div>
            <div id="calc-result" class="text-center" style="font-size: 18px; font-weight: bold;"></div>
        </div>
        <div class="card">
            <h3>1RM Estimator (Epley)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <input type="number" id="orm-weight" placeholder="Weight" oninput="calculateORM()">
                <input type="number" id="orm-reps" placeholder="Reps" oninput="calculateORM()">
            </div>
            <div id="orm-result" class="text-center" style="font-weight:bold; color:var(--accent); margin-top:10px;">-</div>
        </div>
    </div>

    <div id="view-settings" class="container hidden">
        <h1>Settings</h1>
        <div class="card mt-4">
            <div class="flex-between" style="margin-bottom:15px;">
                <span>Haptic Feedback</span>
                <input type="checkbox" id="setting-haptics" checked onchange="saveSettings()">
            </div>
            <div class="flex-between" style="margin-bottom:15px;">
                <span>Auto-Start Timer (2m)</span>
                <input type="checkbox" id="setting-autotimer" checked onchange="saveSettings()">
            </div>
            <div class="flex-between">
                <span>Dark Mode</span>
                <input type="checkbox" checked disabled>
            </div>
        </div>
        <div class="text-center text-sm" style="color: #444; margin-top: 40px;">
            ZeroLog v1.1.0 (AI-Enhanced)<br>
            No Cloud. No Accounts.
            <br><a href="privacy.html" style="color:#666;">Privacy Policy</a>
        </div>
    </div>

    <div id="timer-banner">
        <div class="timer-content">
            <div>
                <div class="text-sm" style="color:#888">Resting...</div>
                <div id="timer-display" class="timer-digits">00:00</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-outline" onclick="addTime(30)">+30s</button>
                <button class="btn-sm btn-danger" onclick="stopTimer()">Skip</button>
            </div>
        </div>
        <div class="ad-container">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:320px;height:50px"
                 data-ad-client="ca-pub-YOUR_ADSENSE_ID"
                 data-ad-slot="YOUR_AD_SLOT_ID"></ins>
        </div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="switchView('workout')">
            <span class="nav-icon">üèãÔ∏è</span>Work
        </button>
        <button class="nav-item" onclick="switchView('history')">
            <span class="nav-icon">üìÖ</span>Logs
        </button>
        <button class="nav-item" onclick="switchView('calc')">
            <span class="nav-icon">üßÆ</span>Calc
        </button>
        <button class="nav-item" onclick="switchView('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>Set
        </button>
    </nav>

<script>
    // --- State Management ---
    const STATE = {
        workouts: [], // Current active workout session
        history: JSON.parse(localStorage.getItem('zerolog_history') || '[]'),
        settings: JSON.parse(localStorage.getItem('zerolog_settings') || '{"haptics":true, "autotimer":true}'),
        timer: null,
        timerSeconds: 0,
        undoStack: null // { type: 'set', data: ..., parentId: ... }
    };

    // --- Core: Init & Rendering ---
    window.addEventListener('load', () => {
        // Init default exercises if empty
        if (!localStorage.getItem('zerolog_exercises')) {
            const defaults = ['Squat', 'Bench Press', 'Deadlift', 'Overhead Press'];
            localStorage.setItem('zerolog_exercises', JSON.stringify(defaults));
        }
        
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        
        renderWorkout();
        calculatePlates(); // Init calc
        checkPWA();
    });

    function switchView(viewName) {
        document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        if(viewName === 'history') renderHistory();
        if(viewName === 'workout') renderWorkout();
    }

    // --- Feature: AI Insights (Client-Side) ---
    function generateInsights() {
        const area = document.getElementById('ai-insights-area');
        area.innerHTML = '';
        if (STATE.history.length < 2) return; // Need data to be smart

        // 1. Recovery/Fatigue Score
        const last7Days = STATE.history.filter(h => (new Date() - new Date(h.date)) < 604800000);
        const weeklySets = last7Days.reduce((acc, h) => acc + h.exercises.reduce((s, e) => s + e.sets.length, 0), 0);
        
        let fatigueHtml = '';
        if (weeklySets > 40) {
            fatigueHtml = `<div class="ai-insight card">
                <div class="insight-header"><span>‚ö†Ô∏è</span> <span class="insight-highlight">High Volume Detected</span></div>
                <div class="insight-text">You've logged <b>${weeklySets} sets</b> this week. Consider a lighter session or extra rest day if joints feel achy.</div>
            </div>`;
        }

        // 2. Progressive Overload Suggestion (Based on last logged exercise)
        let suggestionHtml = '';
        if (STATE.workouts.length > 0) {
            const lastExName = STATE.workouts[STATE.workouts.length - 1].name;
            const historyEx = getExerciseHistory(lastExName);
            
            if (historyEx) {
                const lastSession = historyEx[0]; // Most recent
                const lastSet = lastSession.sets[0];
                if (lastSet) {
                    // Simple Logic: If >5 reps, suggest weight increase
                    const suggestWeight = parseInt(lastSet.reps) >= 5 
                        ? (parseFloat(lastSet.weight) + 2.5) 
                        : parseFloat(lastSet.weight);
                    
                    suggestionHtml = `<div class="ai-insight card">
                        <div class="insight-header"><span>ü§ñ</span> <span class="insight-highlight">Smart Suggestion: ${lastExName}</span></div>
                        <div class="insight-text">Last time: ${lastSet.weight}kg x ${lastSet.reps}. <br>Target today: <span class="insight-highlight">${suggestWeight}kg</span> to ensure progressive overload.</div>
                    </div>`;
                }
            }
        }

        area.innerHTML = fatigueHtml + suggestionHtml;
    }

    // --- Workout Logic ---
    function renderWorkout() {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';
        
        generateInsights(); // Run AI check

        if (STATE.workouts.length === 0) {
            list.innerHTML = `<div class="text-center" style="margin-top:50px; color:var(--text-dim)">
                <h3>Ready to lift?</h3>
                <p>Add an exercise to start logging.</p>
            </div>`;
            return;
        }

        STATE.workouts.forEach((ex, exIndex) => {
            const history = getExerciseHistory(ex.name);
            const prevStr = history.length ? `Prev: ${history[0].sets[0].weight}kg x ${history[0].sets[0].reps}` : 'New Exercise';

            let html = `<div class="card">
                <div class="exercise-header">
                    <div>
                        <h2>${ex.name}</h2>
                        <div class="set-history">${prevStr}</div>
                    </div>
                    <button class="btn-sm btn-danger" onclick="removeExercise(${exIndex})">√ó</button>
                </div>
                <div id="sets-${exIndex}">`;

            ex.sets.forEach((set, setIndex) => {
                // PR Check Logic (1RM based)
                const isPR = checkPR(ex.name, set.weight, set.reps);
                const prBadge = isPR ? `<span class="badge badge-pr">New PR!</span>` : '';

                html += `
                <div class="set-row">
                    <input type="number" placeholder="kg" value="${set.weight}" onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)" inputmode="decimal">
                    <input type="number" placeholder="reps" value="${set.reps}" onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)" inputmode="numeric">
                    <button class="btn-sm btn-danger" onclick="deleteSet(${exIndex}, ${setIndex})">üóë</button>
                </div>
                ${isPR ? `<div style="text-align:right; margin-top:-8px; margin-bottom:8px;">${prBadge}</div>` : ''}
                `;
            });

            html += `</div>
                <button class="btn btn-sm btn-outline mt-4" onclick="addSet(${exIndex})">+ Add Set</button>
            </div>`;
            list.innerHTML += html;
        });
        
        // Add Finish Button if workout exists
        if (STATE.workouts.length > 0) {
            list.innerHTML += `<button class="btn" style="margin-top:20px; background:var(--success)" onclick="finishWorkout()">Finish Workout üéâ</button>`;
        }
    }

    function addSet(exIndex) {
        // Copy previous set if exists
        const prevSet = STATE.workouts[exIndex].sets[STATE.workouts[exIndex].sets.length - 1];
        STATE.workouts[exIndex].sets.push(prevSet ? {...prevSet} : {weight: '', reps: ''});
        renderWorkout();
    }

    function updateSet(exIndex, setIndex, field, value) {
        STATE.workouts[exIndex].sets[setIndex][field] = value;
        // Check for auto-complete/timer trigger could go here
        if (field === 'reps' && value !== '' && STATE.settings.autotimer) {
            startTimer(120); // 2 min auto timer
        }
    }

    function deleteSet(exIndex, setIndex) {
        // Save for undo
        STATE.undoStack = {
            type: 'set',
            exIndex: exIndex,
            data: STATE.workouts[exIndex].sets[setIndex]
        };
        
        STATE.workouts[exIndex].sets.splice(setIndex, 1);
        renderWorkout();
        showUndoToast();
    }

    function showExerciseSelector() {
        const selector = document.getElementById('exercise-selector');
        const dl = document.getElementById('exercise-suggestions');
        const customEx = JSON.parse(localStorage.getItem('zerolog_exercises'));
        
        dl.innerHTML = '';
        customEx.forEach(ex => {
            dl.innerHTML += `<option value="${ex}">`;
        });
        
        selector.classList.remove('hidden');
        document.getElementById('new-exercise-name').focus();
    }

    function addNewExercise() {
        const input = document.getElementById('new-exercise-name');
        const name = input.value.trim();
        if (!name) return;

        // Save to suggestions if new
        const existing = JSON.parse(localStorage.getItem('zerolog_exercises'));
        if (!existing.includes(name)) {
            existing.push(name);
            localStorage.setItem('zerolog_exercises', JSON.stringify(existing));
        }

        STATE.workouts.push({ name: name, sets: [{weight: '', reps: ''}] });
        input.value = '';
        document.getElementById('exercise-selector').classList.add('hidden');
        renderWorkout();
    }

    function hideExerciseSelector() {
        document.getElementById('exercise-selector').classList.add('hidden');
    }

    function removeExercise(index) {
        if(confirm('Remove this exercise?')) {
            STATE.workouts.splice(index, 1);
            renderWorkout();
        }
    }

    function finishWorkout() {
        if (STATE.workouts.length === 0) return;
        
        // Remove empty sets
        STATE.workouts.forEach(ex => {
            ex.sets = ex.sets.filter(s => s.weight && s.reps);
        });

        const session = {
            id: Date.now(),
            date: new Date().toISOString(),
            exercises: STATE.workouts
        };

        STATE.history.unshift(session);
        localStorage.setItem('zerolog_history', JSON.stringify(STATE.history));
        
        // Confetti
        confettiEffect();
        
        STATE.workouts = [];
        renderWorkout();
        switchView('history');
    }

    // --- Helpers: PR & Stats ---
    function calc1RM(weight, reps) {
        if (reps == 1) return weight;
        return Math.round(weight * (1 + reps/30));
    }

    function checkPR(exName, weight, reps) {
        if (!weight || !reps) return false;
        const current1RM = calc1RM(parseFloat(weight), parseFloat(reps));
        
        const history = getExerciseHistory(exName);
        if (!history.length) return true; // First time is always a PR

        // Find max 1RM in history
        let max1RM = 0;
        history.forEach(session => {
            session.exercises.forEach(e => {
                if (e.name === exName) {
                    e.sets.forEach(s => {
                        const s1RM = calc1RM(parseFloat(s.weight), parseFloat(s.reps));
                        if (s1RM > max1RM) max1RM = s1RM;
                    });
                }
            });
        });

        return current1RM > max1RM;
    }

    function getExerciseHistory(name) {
        // Returns sessions containing this exercise
        return STATE.history.filter(h => h.exercises.some(e => e.name === name));
    }

    // --- Undo Logic ---
    function showUndoToast() {
        const t = document.getElementById('toast');
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 5000);
    }

    function undoAction() {
        if (!STATE.undoStack) return;
        
        if (STATE.undoStack.type === 'set') {
            const { exIndex, data } = STATE.undoStack;
            // Handle edge case where exercise was removed
            if (STATE.workouts[exIndex]) {
                STATE.workouts[exIndex].sets.push(data);
                renderWorkout();
            }
        }
        document.getElementById('toast').classList.remove('visible');
        STATE.undoStack = null;
    }

    // --- Timer Logic (With Ad Fix) ---
    function startTimer(seconds) {
        if(STATE.timer) clearInterval(STATE.timer);
        STATE.timerSeconds = seconds;
        
        const banner = document.getElementById('timer-banner');
        banner.style.display = 'flex';
        updateTimerDisplay();
        
        // AD FIX: Always attempt to push ad request when timer starts
        try {
            (adsbygoogle = window.adsbygoogle || []).push({});
        } catch (e) {
            console.log("AdSense push deferred or limited");
        }

        if (STATE.settings.haptics && navigator.vibrate) navigator.vibrate(50);

        STATE.timer = setInterval(() => {
            STATE.timerSeconds--;
            updateTimerDisplay();
            if (STATE.timerSeconds <= 0) {
                stopTimer();
                if (STATE.settings.haptics && navigator.vibrate) navigator.vibrate([200, 100, 200]);
                new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...').play().catch(()=>{}); // Beep placeholder
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(STATE.timer);
        document.getElementById('timer-banner').style.display = 'none';
    }

    function addTime(s) {
        STATE.timerSeconds += s;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const m = Math.floor(STATE.timerSeconds / 60).toString().padStart(2, '0');
        const s = (STATE.timerSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    }

    // --- Calculator Logic ---
    function calculatePlates() {
        const weight = parseFloat(document.getElementById('calc-weight').value) || 0;
        const bar = 20;
        let remaining = (weight - bar) / 2;
        
        const plates = [20, 15, 10, 5, 2.5, 1.25];
        const result = [];
        const visuals = document.getElementById('plate-visuals');
        visuals.innerHTML = '<div class="bar"></div>'; // Reset visual

        if (remaining <= 0) {
            document.getElementById('calc-result').innerText = "Just the bar!";
            return;
        }

        plates.forEach(p => {
            while (remaining >= p) {
                result.push(p);
                remaining -= p;
                
                // Visual Generation
                const colorClass = p === 20 ? 'p-20' : p === 10 ? 'p-10' : p === 5 ? 'p-5' : 'p-2-5';
                visuals.innerHTML += `<div class="plate ${colorClass}">${p}</div>`;
            }
        });

        document.getElementById('calc-result').innerText = `Per Side: ${result.join(', ')}`;
    }

    function calculateORM() {
        const w = parseFloat(document.getElementById('orm-weight').value) || 0;
        const r = parseFloat(document.getElementById('orm-reps').value) || 0;
        if(w && r) {
            document.getElementById('orm-result').innerText = `Est. 1RM: ${calc1RM(w,r)}kg`;
        }
    }

    // --- History & Data (Import Deduplication Fix) ---
    function renderHistory() {
        const div = document.getElementById('history-list');
        div.innerHTML = '';
        STATE.history.forEach(h => {
            const date = new Date(h.date).toLocaleDateString();
            const summary = h.exercises.map(e => `${e.sets.length}x ${e.name}`).join(', ');
            div.innerHTML += `
            <div class="card">
                <div class="flex-between">
                    <b>${date}</b>
                    <span class="text-sm" style="color:#666">ID: ${h.id ? h.id.toString().slice(-4) : 'OLD'}</span>
                </div>
                <div style="margin-top:5px; color:#aaa">${summary}</div>
            </div>`;
        });
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(STATE.history));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "zerolog_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                // DEDUPLICATION FIX: Merge based on ID
                const currentIds = new Set(STATE.history.map(h => h.id));
                let addedCount = 0;
                
                imported.forEach(item => {
                    // Backwards compatibility for old data without IDs
                    if (!item.id || !currentIds.has(item.id)) {
                        STATE.history.push(item);
                        addedCount++;
                    }
                });
                
                // Sort by date new -> old
                STATE.history.sort((a,b) => new Date(b.date) - new Date(a.date));
                
                localStorage.setItem('zerolog_history', JSON.stringify(STATE.history));
                alert(`Imported ${addedCount} workouts successfully.`);
                renderHistory();
            } catch (err) {
                alert('Invalid JSON file');
            }
        };
        reader.readAsText(file);
    }

    function saveSettings() {
        STATE.settings.haptics = document.getElementById('setting-haptics').checked;
        STATE.settings.autotimer = document.getElementById('setting-autotimer').checked;
        localStorage.setItem('zerolog_settings', JSON.stringify(STATE.settings));
    }

    // --- Service Worker (PWA) ---
    function checkPWA() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
        }
    }

    // --- Visual Effects ---
    function confettiEffect() {
        // Simple canvas confetti implementation could go here
        // For minimalist single file, we use a CSS animation on the button instead
        const btn = document.querySelector('.btn[onclick="finishWorkout()"]');
        if(btn) {
            btn.innerText = "SAVED! üî•";
            setTimeout(() => btn.innerText = "Finish Workout", 2000);
        }
    }
</script>
</body>
</html>

