<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZeroLog</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo512.png">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_ID" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-dim: #8e8e93;
            --accent: #2563eb;
            --accent-dim: #1d4ed8;
            --success: #32d74b;
            --danger: #ff453a;
            --warning: #ff9f0a;
            --border: #2c2c2e;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        h1, h2, h3 { margin: 0; font-weight: 600; }
        .container { padding: 20px; flex: 1; overflow-y: auto; }
        .hidden { display: none !important; }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .nav-item {
            color: var(--text-dim);
            text-align: center;
            font-size: 10px;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* Cards & Inputs */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 8px 12px; font-size: 14px; width: auto; }

        input, select {
            background: #2c2c2e;
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        input:focus { outline: 2px solid var(--accent); }

        /* Workout View */
        .set-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .set-history { font-size: 12px; color: var(--text-dim); margin-bottom: 4px; }
        .exercise-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 8px;
        }
        .badge-pr { background: linear-gradient(45deg, #ff9f0a, #ff453a); color: white; box-shadow: 0 2px 8px rgba(255, 69, 58, 0.4); }

        /* Rest Timer Banner */
        #timer-banner {
            position: fixed;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background: #111;
            border: 1px solid var(--accent);
            border-radius: 12px;
            z-index: 90;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .timer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }
        .timer-digits { font-size: 24px; font-weight: bold; font-variant-numeric: tabular-nums; color: var(--accent); }
        .ad-container {
            width: 100%;
            min-height: 50px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #333;
        }
        
        /* AI Insights Section */
        .ai-insight {
            background: linear-gradient(145deg, #1c1c1e 0%, #161618 100%);
            border-left: 3px solid var(--accent);
            margin-bottom: 20px;
            animation: fadeIn 0.5s;
        }
        .insight-header { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .insight-text { font-size: 14px; line-height: 1.4; color: var(--text-dim); }
        .insight-highlight { color: var(--accent); font-weight: 600; }

        /* Custom Modal (Replaces standard Alert/Confirm) */
        #custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        #custom-modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-box {
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            border: 1px solid var(--border);
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        #custom-modal-overlay.active .modal-box { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .modal-msg { color: var(--text-dim); margin-bottom: 20px; font-size: 15px; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }

        /* Toast Notification */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #toast.visible { opacity: 1; pointer-events: all; }
        
        /* Utility & Calc */
        .text-center { text-align: center; }
        .text-sm { font-size: 13px; }
        .mt-4 { margin-top: 16px; }
        .flex-between { display: flex; justify-content: space-between; }
        .plate-stack { display: flex; align-items: center; justify-content: center; gap: 2px; margin: 20px 0; height: 100px; }
        .bar { width: 10px; height: 100%; background: #555; border-radius: 2px; }
        .plate { height: 80%; width: 15px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 8px; color: #000; font-weight: bold; }
        .p-20 { background: #2563eb; height: 90%; width: 20px; }
        .p-10 { background: #32d74b; height: 70%; }
        .p-5 { background: #ff453a; height: 50%; }
        .p-2-5 { background: #8e8e93; height: 40%; }
    </style>
</head>
<body>

    <div id="toast">
        <span id="toast-msg">Item deleted</span>
        <button class="btn-sm btn-outline" onclick="undoAction()" style="border-color: #555;">UNDO</button>
    </div>

    <div id="custom-modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">Confirm</div>
            <div class="modal-msg" id="modal-msg">Are you sure?</div>
            <div class="modal-actions" id="modal-actions">
                </div>
        </div>
    </div>

    <div id="view-workout" class="container">
        <div class="flex-between" style="align-items: flex-end; margin-bottom: 20px;">
            <h1>Workout</h1>
            <span class="text-sm" style="color:var(--text-dim)" id="current-date"></span>
        </div>

        <div id="ai-insights-area"></div>
        <div id="workout-list"></div>
        
        <button class="btn btn-outline" onclick="showExerciseSelector()">+ Add Exercise</button>

        <div id="exercise-selector" class="card hidden" style="margin-top: 20px;">
            <h3>Add Exercise</h3>
            <input type="text" id="new-exercise-name" placeholder="Search or Type new..." list="exercise-suggestions">
            <datalist id="exercise-suggestions"></datalist>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="addNewExercise()">Add</button>
                <button class="btn btn-danger" onclick="hideExerciseSelector()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="view-history" class="container hidden">
        <h1>History</h1>
        <div id="history-list" class="mt-4"></div>
        <button class="btn btn-outline mt-4" onclick="exportData()">Export Data (JSON)</button>
        <div style="margin-top:10px;">
            <label class="btn btn-outline" style="display:block; text-align:center;">
                Import Data (JSON)
                <input type="file" onchange="importData(this)" style="display:none" accept=".json">
            </label>
        </div>
    </div>

    <div id="view-calc" class="container hidden">
        <h1>Plate Calc</h1>
        <div class="card mt-4">
            <label class="text-sm">Target Weight (kg)</label>
            <input type="number" id="calc-weight" value="100" oninput="calculatePlates()" inputmode="decimal">
            <div class="plate-stack" id="plate-visuals"></div>
            <div id="calc-result" class="text-center" style="font-size: 18px; font-weight: bold;"></div>
        </div>
        <div class="card">
            <h3>1RM Estimator (Epley)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <input type="number" id="orm-weight" placeholder="Weight" oninput="calculateORM()">
                <input type="number" id="orm-reps" placeholder="Reps" oninput="calculateORM()">
            </div>
            <div id="orm-result" class="text-center" style="font-weight:bold; color:var(--accent); margin-top:10px;">-</div>
        </div>
    </div>

    <div id="view-settings" class="container hidden">
        <h1>Settings</h1>
        <div class="card mt-4">
            <div class="flex-between" style="margin-bottom:15px;">
                <span>Haptic Feedback</span>
                <input type="checkbox" id="setting-haptics" checked onchange="saveSettings()">
            </div>
            <div class="flex-between" style="margin-bottom:15px;">
                <span>Auto-Start Timer (2m)</span>
                <input type="checkbox" id="setting-autotimer" checked onchange="saveSettings()">
            </div>
            <div class="flex-between">
                <span>Dark Mode</span>
                <input type="checkbox" checked disabled>
            </div>
        </div>
        <div class="text-center text-sm" style="color: #444; margin-top: 40px;">
            ZeroLog v1.1.0<br>
            <a href="privacy.html" style="color:#666;">Privacy Policy</a>
        </div>
    </div>

    <div id="timer-banner">
        <div class="timer-content">
            <div>
                <div class="text-sm" style="color:#888">Resting...</div>
                <div id="timer-display" class="timer-digits">00:00</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-outline" onclick="addTime(30)">+30s</button>
                <button class="btn-sm btn-danger" onclick="stopTimer()">Skip</button>
            </div>
        </div>
        <div class="ad-container">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:320px;height:50px"
                 data-ad-client="ca-pub-YOUR_ADSENSE_ID"
                 data-ad-slot="YOUR_AD_SLOT_ID"></ins>
        </div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="switchView('workout')"><span class="nav-icon">üèãÔ∏è</span>Work</button>
        <button class="nav-item" onclick="switchView('history')"><span class="nav-icon">üìÖ</span>Logs</button>
        <button class="nav-item" onclick="switchView('calc')"><span class="nav-icon">üßÆ</span>Calc</button>
        <button class="nav-item" onclick="switchView('settings')"><span class="nav-icon">‚öôÔ∏è</span>Set</button>
    </nav>

<script>
    const STATE = {
        workouts: [],
        history: JSON.parse(localStorage.getItem('zerolog_history') || '[]'),
        settings: JSON.parse(localStorage.getItem('zerolog_settings') || '{"haptics":true, "autotimer":true}'),
        timer: null,
        timerSeconds: 0,
        undoStack: null
    };

    window.addEventListener('load', () => {
        if (!localStorage.getItem('zerolog_exercises')) {
            const defaults = ['Squat', 'Bench Press', 'Deadlift', 'Overhead Press'];
            localStorage.setItem('zerolog_exercises', JSON.stringify(defaults));
        }
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        renderWorkout();
        calculatePlates();
        checkPWA();
    });

    // --- Custom Modal System (No Domain Popups) ---
    function showModal(title, msg, onConfirm, isAlert = false) {
        const overlay = document.getElementById('custom-modal-overlay');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = msg;
        const actions = document.getElementById('modal-actions');
        
        actions.innerHTML = '';
        if (isAlert) {
            const btnOk = document.createElement('button');
            btnOk.className = 'btn btn-sm';
            btnOk.innerText = 'OK';
            btnOk.onclick = closeModal;
            actions.appendChild(btnOk);
        } else {
            const btnCancel = document.createElement('button');
            btnCancel.className = 'btn btn-sm btn-outline';
            btnCancel.innerText = 'Cancel';
            btnCancel.onclick = closeModal;
            
            const btnYes = document.createElement('button');
            btnYes.className = 'btn btn-sm btn-danger';
            btnYes.innerText = 'Yes';
            btnYes.onclick = () => {
                onConfirm();
                closeModal();
            };
            
            actions.appendChild(btnCancel);
            actions.appendChild(btnYes);
        }
        overlay.classList.add('active');
    }

    function closeModal() {
        document.getElementById('custom-modal-overlay').classList.remove('active');
    }

    function switchView(viewName) {
        document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(viewName === 'history') renderHistory();
        if(viewName === 'workout') renderWorkout();
    }

    // --- AI & Logic ---
    function generateInsights() {
        const area = document.getElementById('ai-insights-area');
        area.innerHTML = '';
        if (STATE.history.length < 2) return; 

        const last7Days = STATE.history.filter(h => (new Date() - new Date(h.date)) < 604800000);
        const weeklySets = last7Days.reduce((acc, h) => acc + h.exercises.reduce((s, e) => s + e.sets.length, 0), 0);
        
        if (weeklySets > 40) {
            area.innerHTML += `<div class="ai-insight card">
                <div class="insight-header"><span>‚ö†Ô∏è</span> <span class="insight-highlight">High Volume</span></div>
                <div class="insight-text">You've logged <b>${weeklySets} sets</b> this week. Watch recovery.</div>
            </div>`;
        }

        if (STATE.workouts.length > 0) {
            const lastExName = STATE.workouts[STATE.workouts.length - 1].name;
            const historyEx = getExerciseHistory(lastExName);
            if (historyEx.length && historyEx[0].sets.length) {
                const lastSet = historyEx[0].sets[0];
                const suggestWeight = parseInt(lastSet.reps) >= 5 ? (parseFloat(lastSet.weight) + 2.5) : parseFloat(lastSet.weight);
                area.innerHTML += `<div class="ai-insight card">
                    <div class="insight-header"><span>ü§ñ</span> <span class="insight-highlight">Suggest: ${lastExName}</span></div>
                    <div class="insight-text">Target: <span class="insight-highlight">${suggestWeight}kg</span></div>
                </div>`;
            }
        }
    }

    function renderWorkout() {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';
        generateInsights(); 

        if (STATE.workouts.length === 0) {
            list.innerHTML = `<div class="text-center" style="margin-top:50px; color:var(--text-dim)"><h3>Ready to lift?</h3><p>Add an exercise to start.</p></div>`;
            return;
        }

        STATE.workouts.forEach((ex, exIndex) => {
            const history = getExerciseHistory(ex.name);
            const prevStr = history.length ? `Prev: ${history[0].sets[0].weight}kg x ${history[0].sets[0].reps}` : 'New Exercise';

            let html = `<div class="card">
                <div class="exercise-header">
                    <div><h2>${ex.name}</h2><div class="set-history">${prevStr}</div></div>
                    <button class="btn-sm btn-danger" onclick="removeExercise(${exIndex})">√ó</button>
                </div>
                <div id="sets-${exIndex}">`;

            ex.sets.forEach((set, setIndex) => {
                const isPR = checkPR(ex.name, set.weight, set.reps);
                html += `<div class="set-row">
                    <input type="number" placeholder="kg" value="${set.weight}" onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)" inputmode="decimal">
                    <input type="number" placeholder="reps" value="${set.reps}" onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)" inputmode="numeric">
                    <button class="btn-sm btn-danger" onclick="deleteSet(${exIndex}, ${setIndex})">üóë</button>
                </div>
                ${isPR ? `<div style="text-align:right; margin-top:-8px; margin-bottom:8px;"><span class="badge badge-pr">New PR!</span></div>` : ''}`;
            });

            html += `</div><button class="btn btn-sm btn-outline mt-4" onclick="addSet(${exIndex})">+ Add Set</button></div>`;
            list.innerHTML += html;
        });
        
        if (STATE.workouts.length > 0) {
            list.innerHTML += `<button class="btn" style="margin-top:20px; background:var(--success)" onclick="finishWorkout()">Finish Workout üéâ</button>`;
        }
    }

    function addSet(exIndex) {
        const prevSet = STATE.workouts[exIndex].sets[STATE.workouts[exIndex].sets.length - 1];
        STATE.workouts[exIndex].sets.push(prevSet ? {...prevSet} : {weight: '', reps: ''});
        renderWorkout();
    }

    function updateSet(exIndex, setIndex, field, value) {
        STATE.workouts[exIndex].sets[setIndex][field] = value;
        if (field === 'reps' && value !== '' && STATE.settings.autotimer) startTimer(120);
    }

    function deleteSet(exIndex, setIndex) {
        STATE.undoStack = { type: 'set', exIndex: exIndex, data: STATE.workouts[exIndex].sets[setIndex] };
        STATE.workouts[exIndex].sets.splice(setIndex, 1);
        renderWorkout();
        showUndoToast();
    }

    function removeExercise(index) {
        // CHANGED: Use Custom Modal instead of native confirm()
        showModal('Remove Exercise', 'Are you sure you want to remove this exercise?', () => {
            STATE.workouts.splice(index, 1);
            renderWorkout();
        });
    }

    function showExerciseSelector() {
        const dl = document.getElementById('exercise-suggestions');
        const customEx = JSON.parse(localStorage.getItem('zerolog_exercises'));
        dl.innerHTML = '';
        customEx.forEach(ex => dl.innerHTML += `<option value="${ex}">`);
        document.getElementById('exercise-selector').classList.remove('hidden');
        document.getElementById('new-exercise-name').focus();
    }

    function addNewExercise() {
        const input = document.getElementById('new-exercise-name');
        const name = input.value.trim();
        if (!name) return;
        const existing = JSON.parse(localStorage.getItem('zerolog_exercises'));
        if (!existing.includes(name)) {
            existing.push(name);
            localStorage.setItem('zerolog_exercises', JSON.stringify(existing));
        }
        STATE.workouts.push({ name: name, sets: [{weight: '', reps: ''}] });
        input.value = '';
        document.getElementById('exercise-selector').classList.add('hidden');
        renderWorkout();
    }

    function hideExerciseSelector() { document.getElementById('exercise-selector').classList.add('hidden'); }

    function finishWorkout() {
        if (STATE.workouts.length === 0) return;
        STATE.workouts.forEach(ex => { ex.sets = ex.sets.filter(s => s.weight && s.reps); });
        const session = { id: Date.now(), date: new Date().toISOString(), exercises: STATE.workouts };
        STATE.history.unshift(session);
        localStorage.setItem('zerolog_history', JSON.stringify(STATE.history));
        
        // Visual confirmation without alert
        const btn = document.querySelector('.btn[onclick="finishWorkout()"]');
        if(btn) {
            const originalText = btn.innerText;
            btn.innerText = "SAVED! üî•";
            btn.style.background = "#fff";
            btn.style.color = "#000";
            setTimeout(() => {
                STATE.workouts = [];
                renderWorkout();
                switchView('history');
            }, 800);
        }
    }

    function calc1RM(weight, reps) { return reps == 1 ? weight : Math.round(weight * (1 + reps/30)); }
    function checkPR(exName, weight, reps) {
        if (!weight || !reps) return false;
        const current1RM = calc1RM(parseFloat(weight), parseFloat(reps));
        const history = getExerciseHistory(exName);
        if (!history.length) return true; 
        let max1RM = 0;
        history.forEach(session => {
            session.exercises.forEach(e => {
                if (e.name === exName) e.sets.forEach(s => {
                    const s1RM = calc1RM(parseFloat(s.weight), parseFloat(s.reps));
                    if (s1RM > max1RM) max1RM = s1RM;
                });
            });
        });
        return current1RM > max1RM;
    }
    function getExerciseHistory(name) { return STATE.history.filter(h => h.exercises.some(e => e.name === name)); }

    function showUndoToast() {
        const t = document.getElementById('toast');
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 5000);
    }
    function undoAction() {
        if (!STATE.undoStack) return;
        if (STATE.undoStack.type === 'set' && STATE.workouts[STATE.undoStack.exIndex]) {
            STATE.workouts[STATE.undoStack.exIndex].sets.push(STATE.undoStack.data);
            renderWorkout();
        }
        document.getElementById('toast').classList.remove('visible');
        STATE.undoStack = null;
    }

    function startTimer(seconds) {
        if(STATE.timer) clearInterval(STATE.timer);
        STATE.timerSeconds = seconds;
        document.getElementById('timer-banner').style.display = 'flex';
        updateTimerDisplay();
        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {}
        if (STATE.settings.haptics && navigator.vibrate) navigator.vibrate(50);
        STATE.timer = setInterval(() => {
            STATE.timerSeconds--;
            updateTimerDisplay();
            if (STATE.timerSeconds <= 0) {
                stopTimer();
                if (STATE.settings.haptics && navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        }, 1000);
    }
    function stopTimer() { clearInterval(STATE.timer); document.getElementById('timer-banner').style.display = 'none'; }
    function addTime(s) { STATE.timerSeconds += s; updateTimerDisplay(); }
    function updateTimerDisplay() {
        const m = Math.floor(STATE.timerSeconds / 60).toString().padStart(2, '0');
        const s = (STATE.timerSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    }

    function calculatePlates() {
        const weight = parseFloat(document.getElementById('calc-weight').value) || 0;
        let remaining = (weight - 20) / 2;
        const plates = [20, 15, 10, 5, 2.5, 1.25];
        const result = [];
        const visuals = document.getElementById('plate-visuals');
        visuals.innerHTML = '<div class="bar"></div>';
        if (remaining <= 0) { document.getElementById('calc-result').innerText = "Just the bar!"; return; }
        plates.forEach(p => {
            while (remaining >= p) {
                result.push(p);
                remaining -= p;
                const c = p === 20 ? 'p-20' : p === 10 ? 'p-10' : p === 5 ? 'p-5' : 'p-2-5';
                visuals.innerHTML += `<div class="plate ${c}">${p}</div>`;
            }
        });
        document.getElementById('calc-result').innerText = `Per Side: ${result.join(', ')}`;
    }

    function calculateORM() {
        const w = parseFloat(document.getElementById('orm-weight').value) || 0;
        const r = parseFloat(document.getElementById('orm-reps').value) || 0;
        if(w && r) document.getElementById('orm-result').innerText = `Est. 1RM: ${calc1RM(w,r)}kg`;
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(STATE.history));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "zerolog_backup.json");
        document.body.appendChild(dl);
        dl.click();
        dl.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                const currentIds = new Set(STATE.history.map(h => h.id));
                let addedCount = 0;
                imported.forEach(item => {
                    if (!item.id || !currentIds.has(item.id)) { STATE.history.push(item); addedCount++; }
                });
                STATE.history.sort((a,b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem('zerolog_history', JSON.stringify(STATE.history));
                
                // CHANGED: Use Custom Modal (Alert Mode)
                showModal('Success', `Imported ${addedCount} workouts.`, closeModal, true);
                renderHistory();
            } catch (err) {
                showModal('Error', 'Invalid JSON file', closeModal, true);
            }
        };
        reader.readAsText(file);
    }

    function saveSettings() {
        STATE.settings.haptics = document.getElementById('setting-haptics').checked;
        STATE.settings.autotimer = document.getElementById('setting-autotimer').checked;
        localStorage.setItem('zerolog_settings', JSON.stringify(STATE.settings));
    }
    function checkPWA() {
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(e => console.log('SW Fail', e));
    }
</script>
</body>
</html>

